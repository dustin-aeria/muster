rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // Helper Functions
    // ============================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is a member of the organization
    function isMemberOf(orgId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + orgId));
    }

    // Get user's membership document for an organization
    function getMembership(orgId) {
      return get(/databases/$(database)/documents/organizationMembers/$(request.auth.uid + '_' + orgId));
    }

    // Check if user has a specific role or higher in the organization
    function hasRole(orgId, allowedRoles) {
      let membership = getMembership(orgId);
      return membership != null &&
        membership.data.status == 'active' &&
        membership.data.role in allowedRoles;
    }

    // Check if user can manage team (admin only)
    function canManageTeam(orgId) {
      return hasRole(orgId, ['admin']);
    }

    // Check if user can delete content (admin or management)
    function canDelete(orgId) {
      return hasRole(orgId, ['admin', 'management']);
    }

    // Check if user can create/edit content (all except viewer)
    function canEdit(orgId) {
      return hasRole(orgId, ['admin', 'management', 'operator']);
    }

    // Check if user can approve workflows (admin or management)
    function canApprove(orgId) {
      return hasRole(orgId, ['admin', 'management']);
    }

    // ============================================
    // Organizations Collection
    // ============================================
    match /organizations/{orgId} {
      // Members can read their organization
      allow read: if isMemberOf(orgId);

      // Only authenticated users can create (will be validated by app logic)
      allow create: if isAuthenticated();

      // Only owners and admins can update organization settings
      allow update: if canManageTeam(orgId);

      // Only admins can delete the organization
      allow delete: if hasRole(orgId, ['admin']);
    }

    // ============================================
    // Organization Members Collection
    // ============================================
    match /organizationMembers/{membershipId} {
      // Users can read memberships where:
      // 1. They are the member (userId matches) - for fetching own memberships
      // 2. They are a member of the same organization - for team listings
      // Note: For list queries, the query must filter by userId OR organizationId
      allow read: if isAuthenticated();

      // Allow creating membership if:
      // 1. User is creating their own admin membership (self-registration), OR
      // 2. User has team management permission in the org (invites)
      allow create: if isAuthenticated() && (
        (request.resource.data.userId == request.auth.uid &&
         request.resource.data.role == 'admin') ||
        canManageTeam(request.resource.data.organizationId)
      );

      // Owners and admins can update roles, users can accept their own invite
      allow update: if isAuthenticated() && (
        canManageTeam(resource.data.organizationId) ||
        (resource.data.userId == request.auth.uid && resource.data.status == 'invited')
      );

      // Owners and admins can remove members, users can remove themselves
      allow delete: if isAuthenticated() && (
        canManageTeam(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid
      );
    }

    // ============================================
    // Projects Collection
    // ============================================
    match /projects/{projectId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Clients Collection
    // ============================================
    match /clients/{clientId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Equipment Collection
    // ============================================
    match /equipment/{equipmentId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Aircraft Collection
    // ============================================
    match /aircraft/{aircraftId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Incidents Collection
    // ============================================
    match /incidents/{incidentId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // CAPAs Collection
    // ============================================
    match /capas/{capaId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Training Collections
    // ============================================
    match /trainingModules/{moduleId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /trainingRecords/{recordId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Compliance Collection
    // ============================================
    match /complianceApplications/{appId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Inspections Collections
    // ============================================
    match /inspections/{inspectionId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /inspectionTemplates/{templateId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /inspectionFindings/{findingId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // COR Audit Collections
    // ============================================
    match /corAudits/{auditId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /corAuditors/{auditorId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /corCertificates/{certId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // JHSC Collections
    // ============================================
    match /jhscMeetings/{meetingId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /jhscMembers/{memberId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /jhscRecommendations/{recId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Policies & Procedures Collections
    // ============================================
    match /policies/{policyId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /procedures/{procedureId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // Master Policies - global templates readable by all authenticated users
    match /masterPolicies/{policyId} {
      allow read: if isAuthenticated();
      // Only system admins should write (handled by admin SDK or restricted)
      allow write: if false;
    }

    // Master Procedures - global templates readable by all authenticated users
    match /masterProcedures/{procedureId} {
      allow read: if isAuthenticated();
      // Only system admins should write (handled by admin SDK or restricted)
      allow write: if false;
    }

    // ============================================
    // Hazard Assessments Collection
    // ============================================
    match /hazardAssessments/{assessmentId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // Formal Hazard Assessments (FHAs)
    match /formalHazards/{fhaId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // Field Hazard Reviews
    match /fieldHazardReviews/{reviewId} {
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         isMemberOf(resource.data.organizationId));
      // Must be member of org to create field hazard reviews
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         canEdit(resource.data.organizationId));
      allow delete: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid ||
         canDelete(resource.data.organizationId));
    }

    // ============================================
    // Maintenance Collections
    // ============================================
    match /maintenanceLogs/{logId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /maintenanceSchedules/{scheduleId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /maintenanceRecords/{recordId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Permits Collection
    // ============================================
    match /permits/{permitId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Checklists Collections
    // ============================================
    match /checklists/{checklistId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    match /checklistTemplates/{templateId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Flight Logs Collection
    // ============================================
    match /flightLogs/{logId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Attachments Collection
    // ============================================
    match /attachments/{attachmentId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Comments Collection
    // ============================================
    match /comments/{commentId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      // Users can update/delete their own comments, or managers+ can delete any
      allow update: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        canEdit(resource.data.organizationId)
      );
      allow delete: if isAuthenticated() && (
        resource.data.authorId == request.auth.uid ||
        canDelete(resource.data.organizationId)
      );
    }

    // ============================================
    // Notifications Collection
    // ============================================
    match /notifications/{notificationId} {
      // Users can read notifications for their organization
      allow read: if isAuthenticated() && (
        isMemberOf(resource.data.organizationId) ||
        resource.data.userId == request.auth.uid ||
        request.auth.uid in resource.data.recipientIds
      );
      // Authenticated users in the org can create notifications
      allow create: if isAuthenticated() &&
        isMemberOf(request.resource.data.organizationId);
      // Allow updates for marking as read, delivery status
      allow update: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isMemberOf(resource.data.organizationId)
      );
      // Users can delete their own notifications
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
    }

    // ============================================
    // Distribution Lists Collection
    // ============================================
    match /distributionLists/{listId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Insurance Collection
    // ============================================
    match /insurancePolicies/{policyId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Templates Collection
    // ============================================
    match /templates/{templateId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Knowledge Base Collection
    // ============================================
    match /knowledgeBase/{articleId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Equipment Assignments Collection
    // ============================================
    match /equipmentAssignments/{assignmentId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Time Entries Collection
    // ============================================
    match /timeEntries/{entryId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Timesheets Collection
    // ============================================
    match /timesheets/{timesheetId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Services Collection
    // ============================================
    match /services/{serviceId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Forms Collection
    // ============================================
    match /forms/{formId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Custom Forms Collection
    // ============================================
    match /customForms/{formId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Safety Metrics Collection
    // ============================================
    match /safetyMetrics/{metricId} {
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // Tasks Collection
    // ============================================
    match /tasks/{taskId} {
      // Org members can read all tasks (visibility filtering done in app layer)
      allow read: if isAuthenticated() &&
        isMemberOf(resource.data.organizationId);

      // Any org member can create tasks
      allow create: if isAuthenticated() &&
        isMemberOf(request.resource.data.organizationId);

      // Creator, assignee, or editors can update
      allow update: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        resource.data.assignedTo == request.auth.uid ||
        canEdit(resource.data.organizationId)
      );

      // Creator or admins can delete
      allow delete: if isAuthenticated() && (
        resource.data.createdBy == request.auth.uid ||
        canDelete(resource.data.organizationId)
      );
    }

    // ============================================
    // Operators Collection (Team Members)
    // ============================================
    match /operators/{operatorId} {
      // Allow users to read their own profile OR members of the organization
      allow read: if isAuthenticated() &&
        (operatorId == request.auth.uid || isMemberOf(resource.data.organizationId));
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      // Allow users to update their own profile OR users with edit permission
      allow update: if isAuthenticated() &&
        (operatorId == request.auth.uid || canEdit(resource.data.organizationId));
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // ============================================
    // User Preferences Collection
    // ============================================
    match /userPreferences/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============================================
    // Settings Collection (Global app settings)
    // ============================================
    match /settings/{settingId} {
      allow read: if isAuthenticated();
      // Global settings should only be modified by admin SDK/Cloud Functions
      allow write: if false;
    }

    // ============================================
    // Organization Settings Collection
    // ============================================
    match /organizationSettings/{orgId} {
      allow read: if isAuthenticated() && isMemberOf(orgId);
      // Only org admins can modify organization settings
      allow write: if isAuthenticated() && canManageTeam(orgId);
    }

    // ============================================
    // Portal Collections (Client Portal)
    // ============================================

    // Portal Users - clients who access via magic link
    match /portalUsers/{portalUserId} {
      // Portal users can read their own data
      // Org members can read portal users for their organization
      allow read: if isAuthenticated() && (
        request.auth.uid == portalUserId ||
        isMemberOf(resource.data.organizationId)
      );
      // Only org admins/management can create/modify portal users
      allow create: if isAuthenticated() &&
        canEdit(request.resource.data.organizationId);
      allow update: if isAuthenticated() &&
        canEdit(resource.data.organizationId);
      allow delete: if isAuthenticated() &&
        canDelete(resource.data.organizationId);
    }

    // Portal Sessions - magic link authentication sessions
    match /portalSessions/{sessionId} {
      // Sessions can be read by the portal user or org members
      allow read: if isAuthenticated() && (
        resource.data.odMemberId == request.auth.uid ||
        isMemberOf(resource.data.organizationId)
      );
      // Sessions are created by Cloud Functions, not directly
      allow create: if false;
      // Sessions can be updated (marked used) by the session owner
      allow update: if isAuthenticated() &&
        resource.data.odMemberId == request.auth.uid;
      // Sessions should be cleaned up by Cloud Functions
      allow delete: if false;
    }
  }
}
